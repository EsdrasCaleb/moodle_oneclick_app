# Automated Moodle for CapRover

This repository provides an automated, production-ready Moodle deployment designed specifically for CapRover.  
It acts as a **self-contained Deployment Manager**, not just a static image.

On every container boot it:

- Downloads Moodle core (Git).
- Installs/updates plugins based on a JSON manifest.
- Regenerates `config.php` dynamically using environment variables.
- Runs Nginx, PHP-FPM and Cron via Supervisor inside a single container.

This makes it fully reproducible and upgradeable with minimal manual work.

---

## üöÄ Features

- **Zero-Touch Config:** `config.php` is autogenerated from environment variables.
- **Plugin Manager:** Installs plugins from Git (supports branches).
- **Auto-Update:** Updates Moodle core + plugins on container restart.
- **Single Container Stack:** Nginx, PHP-FPM and Cron preconfigured.
- **Custom PHP Injection:** Add custom lines directly via `MOODLE_EXTRA_PHP`.
- **Ideal for CapRover:** Works with CapRover reverse proxy, HTTPS, env-based setup.

---

## üì¶ Installation Options

You can deploy this Moodle image in two ways:

### **1. Install using CapRover One-Click App (recommended)**

Add this line to your CapRover template UI:

```

[https://raw.githubusercontent.com/EsdrasCaleb/moodle_oneclick_app/main/oneclick.yml](https://raw.githubusercontent.com/EsdrasCaleb/moodle_oneclick_app/main/oneclick.yml)

```

Then deploy it normally through the One-Click App wizard.

---

### **2. Install using ‚ÄúDeploy from Git‚Äù (classic method)**

Prerequisites:
- A running CapRover server.
- A working database (PostgreSQL or MySQL/MariaDB) ‚Äî can be installed via CapRover One-Click Apps.

Steps:

1. Create a new CapRover app (example: `mymoodle`).
2. Go to the **Deployment** tab ‚Üí *Method 3: Deploy from GitHub*.
3. Enter the repository URL:

```

[https://github.com/EsdrasCaleb/moodle_oneclick_app](https://github.com/EsdrasCaleb/moodle_oneclick_app)

```
4. Branch:  
```

main

```
5. Click **Save & Update**.

The first boot will fail or restart. This is normal ‚Äî the app needs environment variables.

6. Open **App Configs**. Fill in the variables listed automatically:

| Variable            | Description                              | Example                    |
|---------------------|------------------------------------------|----------------------------|
| MOODLE_URL          | Public HTTPS domain                      | https://mymoodle.yourdomain.com |
| DB_HOST             | Internal DB host (CapRover service name) | srv-captain--my-postgres   |
| DB_NAME             | Database name                            | moodle                     |
| DB_USER             | Database user                            | moodle / postgres          |
| DB_PASS             | Database password                        | mypassword123              |
| DB_TYPE             | Database driver                          | pgsql or mysqli            |
| MOODLE_EXTRA_PHP    | Inject raw PHP into config.php           | $CFG->sslproxy = 1;        |
| MOODLE_VERSION      | Moodle branch                            | MOODLE_405_STABLE          |
| MOODLE_PLUGINS_JSON | Git plugin list                          | `[]`                       |
| MOODLE_ADMIN_USER | Moodle default admin username            | `admin`                    |
| MOODLE_ADMIN_PASS | Moodle default admin password            | `MoodleAdmin123`          |
| MOODLE_ADMIN_EMAIL | Moodle default admin email               | `admin@example.com`      |


7. Click **Save & Update**.  
Moodle will be installed automatically.

---

## üß© Plugin Management (JSON)

Plugins are defined using `MOODLE_PLUGINS_JSON` or via a `plugins.json` file in your fork.

Format:

```

[
{
"giturl": "[https://github.com/moodle/moodle-mod_hvp.git](https://github.com/moodle/moodle-mod_hvp.git)",
"branch": "stable",
"installpath": "mod/hvp"
},
{
"giturl": "[https://github.com/ethiz/moodle-theme_moove.git](https://github.com/ethiz/moodle-theme_moove.git)",
"installpath": "theme/moove"
}
]

```

Behavior:
- If directory does not exist ‚Üí `git clone`
- If directory exists ‚Üí `git pull` (+ checkout branch if defined)
- After updates, `upgrade.php` runs automatically.

---

## ‚öôÔ∏è Advanced Configuration (config.php)

`config.php` is **recreated on each boot**.  
You cannot edit it manually.

To add custom configurations, use `MOODLE_EXTRA_PHP`.

Example:

```

$CFG->sslproxy = 1;
// $CFG->debug = 32767; $CFG->debugdisplay = 1;

```

This block is injected directly before Moodle initialization.

---

## üíæ Data Persistence

- `/var/www/moodledata` is persisted via Docker volume (automatically handled by CapRover).
- `/var/www/html` (Moodle core) is **not persisted** ‚Äî updates come from Git or image tag.  
  **Do not manually edit core files inside the container.**

---

## ‚ö†Ô∏è Troubleshooting

1. **Redirect loop / HTTPS problems**

   Add:
```

$CFG->sslproxy = 1;

```

2. **First boot takes several minutes**

The container downloads ~500MB from GitHub (Moodle core + plugins).  
Check CapRover logs to monitor progress.

3. **Changing PHP version**

PHP version is defined in the Docker image.  
Change `PHP_VERSION` in Dockerfile or use another tag, then redeploy.

---

## ‚úîÔ∏è Supported Scenarios

This image works for:

- CapRover One-Click App
- Git-based deployments
- PostgreSQL or MySQL/MariaDB
- External DBs
- Custom themes via Git
- Production HTTPS setups (reverse proxy compliant)

---
